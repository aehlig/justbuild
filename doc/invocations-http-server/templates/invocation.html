{% extends "base.html" %}
{% block heading %}
Inocations {{invocation | e}}
{% endblock %}

{% macro show_action(action) %}
<li>
  <details>
    <summary>
      {{ action["name_prefix"] | e }} <tt>{{ action["name"] | e}}</tt>
      {% if action["may_fail"] %}
      {% if action["exit_code"] != 0 %}
      failure: <b>{{ action["may_fail"] }}</b>
      {% else %}
      tainted (<tt>{{ action["may_fail"] }}</tt>)
      {% endif %}
      {% elif action["primary_output"] %}
      {% if action["exit_code"] != 0 %}
      failed to build: <b>{{ action["primary_output"] | e }}</b>
      {% else %}
      build: <tt>{{ action["primary_output"] | e }}</tt>
      {% endif %}
      {% endif %}
    </summary>
    <ul>
      {% if action["stdout"] %}
      <li> stdout: <a href="/blob/{{ action["stdout"] | e }}">{{action["stdout"] | e }}</a></li>
      {% endif %}
      {% if action["stderr"] %}
      <li> stderr: <a href="/blob/{{ action["stderr"] | e }}">{{action["stderr"] | e }}</a></li>
      {% endif %}
      {% if action["cmd"] %}
      <li>
        <details>
          <summary>command</summary>
          <tt>{{ action["cmd"] | e }}</tt>
        </details>
      </li>
      {% endif %}
      {% if action["origins"] %}
      <li> origins
        <ul>
          {% for origin in action["origins"] %}
          <li> <tt>{{ origin | e }}</tt></li>
          {% endfor %}
        </ul>
      </li>
      {% endif %}
      {% if action["duration"] %}
      <li> duration: {{ action["duration"] | e  }}</li>
      {% endif %}
      {% if action["cached"] %}
      <li> cached: {{ action["cached"] | e }}</li>
      {% endif %}
      {% if action["exit_code"] != 0 %}
      <li> exit code: {{ action["exit_code"] }}</li>
      {% endif %}
      {% if action["output"] %}
      <li> output
        <ul>
          {% for out in action["output"] %}
          {% if action["artifacts"].get(out) %}
          <li>
            <a href="/blob/{{ action["artifacts"].get(out) | e}}"><tt>{{ out | e }}</tt></a>
            <a href="/blob/{{ action["artifacts"].get(out) | e}}/{{ out | e}}"><tt>[&darr;]</tt></a>
          </li>
          {% else %}
          <li> <tt>{{ out | e }}</tt></li>
          {% endif %}
          {% endfor %}
        </ul>
      </li>
      {% endif %}
      {% if action["output_dirs"] %}
      <li> output directories
        <ul>
          {% for out in action["output_dirs"] %}
          {% if action["artifacts"].get(out) %}
          <li> <a href="/tree/{{ action["artifacts"].get(out) | e}}"><tt>{{ out | e }}</tt></a></li>
          {% else %}
          <li> <tt>{{ out | e }}</tt></li>
          {% endif %}
          {% endfor %}
        </ul>
      </li>
      {% endif %}
    </ul>
  </details>
</li>
{% endmacro %}

{% block content %}
<h1>Invocation {{invocation | e}}</h1>

<h2>Overview</h2>
<ul>
  {% if cmd %}
  <li> Subcommand and positional arguments: <span id="invocation-target"><tt>{{ cmd | e }}</tt></span></li>
  {% endif %}
  {% if cmdline %}
  <li>
    <details>
      <summary>Full command line</summary>
      <tt>{{ cmdline | e }}</tt>
    </details>
  </li>
  {% endif %}
  {% if repo_config %}
  <li> Repository configuration:
    <a href="/blob/{{ repo_config | e }}"><tt>{{ repo_config | e}}</tt></a>
  </li>
  {% endif %}
  {% if target %}
  <li> Target: <tt>{{ target | e }}</tt></li>
  {% endif %}
  {% if config %}
  <li> Target configuration: <tt>{{ config | e }}</tt></li>
  {% endif %}
  {% if remote_address %}
  <li> Remote:
    <ul>
      <li> Address: <tt>{{ remote_address | e }}</tt></li>
      {% if remote_props %}
      <li> Properties:
        <ul>
          {% for prop in remote_props %}
          <li> <tt>{{ prop["key"] | e }}</tt> :
            <a href="/filterinvocations/remote/prop/{{ prop["key_hex"] | e }}/{{ prop["value_hex"] }}"><tt>{{ prop["value"] | e }}</tt></a>
          </li>
          {% endfor %}
        </ul>
      </li>
      {% else %}
      <li> Properties: <i>(none)</i></li>
      {% endif %}
      <li> Dispatch: <tt>{{ remote_dispatch | e }}</tt></li>
    </ul>
  </li>
  {% endif %}
  {% if context %}
  <li> Context:
    <ul>
      {% for entry in context %}
      <li> <tt>{{ entry["key"] | e }}</tt> :
        <a href="/filterinvocations/context/{{ entry["key_hex"] | e }}/{{ entry["value_hex"] }}"><tt>{{ entry["value"] | e }}</tt></a>
      </li>
      {% endfor %}
    </ul>
  </li>
  {% else %}
  <li> Context: <i>(none)</i></li>
  {% endif %}
  {% if exit_code != None %}
  <li> Exit code: <tt>{{ exit_code | e }}</tt></li>
  {% endif %}
  {% if artifacts %}
  <li>
    <details>
      <summary>{{ artifacts_count | e }} artifacts</summary>
      <ul>
        {% for entry in artifacts %}
        <li>
          <a href="/{{ entry["type"] | e}}/{{ entry["hash"] | e}}">{{ entry["path"] | e}}</a>
          {% if entry["type"] == "blob" %}
          <a href="/blob/{{ entry["hash"] | e}}/{{ entry["basename"] | e}}">[&darr;]</a>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    </details>
  </li>
  {% endif %}
</ul>

{% if have_profile %}
{% if analysis_errors %}
<h2>Analysis errors</h2>
<ul>
  {% for error in analysis_errors %}
  <li> <pre>{{ error["msg"] | e}}</pre>
    {% if error["blobs"] %}
    Blobs:
    {% for blob in error["blobs"] %}
    <a href="/blob/{{ blob | e }}"><tt>{{ blob | e }}</tt></a>
    {% endfor %}
    {% endif %}
  </li>
  {% endfor %}
</ul>
{% else %}
{% if exit_code == 0 or exit_code == 1 or exit_code == 2 %}
<h2>Actions</h2>
<ul>
  <li> Processed: <tt>{{ action_count | e }}</tt></li>
  <li> Cached: <tt>{{ action_count_cached | e }}</tt></li>
</ul>

<h3>Failed actions</h3>
{% if failed_actions %}
<ul>
  {% for action in failed_actions %}
  {{ show_action(action) }}
  {% endfor %}
</ul>
{% else %}
<i>(none)</i>
{% endif %}

<h3>Other actions with console output</h3>
{% if output_actions %}
<ul>
  {% for action in output_actions %}
  {{ show_action(action) }}
  {% endfor %}
</ul>
{% else %}
<i>(none)</i>
{% endif %}


<h3>Remaining non-cached actions</h3>
{% if non_cached %}
In order of decreasing run time.
<ul>
  {% for action in non_cached %}
  {{ show_action(action) }}
  {% endfor %}
  {% if more_non_cached %}
  <li> &hellip; and {{ more_non_cached | e }} actions</li>
  {% endif %}
</ul>
{% else %}
<i>(none)</i>
{% endif %}
{% endif %}
{% endif %}
{% else %}
<b>No profiling data available; invocation data is not (yet) complete.</b>
{% endif %}


{% endblock %}
